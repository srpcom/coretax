<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daftar Hadir BIMTEK SPT</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/srpcom/koesmaparkir/main/new%20logo%20rsud%202025%20kecil.png">
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #005A9C; --secondary-color: #F0F8FF; --border-color: #DCDCDC;
            --text-color: #333; --success-color: #28a745; --error-color: #dc3545;
            --pending-bg: #fffbe6; --pending-color: #9c6f00; --pending-border: #ffe58f;
            --completed-bg: #f6ffed; --completed-color: #389e0d; --completed-border: #b7eb8f;
            --rejected-bg: #fff1f0; --rejected-color: #cf1322; --rejected-border: #ffa39e;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        body { font-family: var(--font-family); background-image: url('https://raw.githubusercontent.com/srpcom/koesmaparkir/main/foto%20ipit.jpg'); background-size: cover; background-position: center; background-attachment: fixed; color: var(--text-color); margin: 0; padding: 10px; transition: background-color 0.3s; }
        .container { max-width: 800px; width: 100%; margin: 20px auto; background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 12px; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); }
        
        #main-form-container .container {
            background-color: rgba(255, 255, 255, 0.5); 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px);
        }

        header { background-color: var(--primary-color); color: white; padding: 20px; text-align: center; border-bottom: 5px solid #00487a; border-radius: 12px 12px 0 0; }
        header .logo-image { width: 70px; margin: 0 auto 15px auto; display: block; }
        header h1 { margin: 0; font-size: 1.5em; }
        header p { margin: 5px 0 0; opacity: 0.9; font-size: 0.9em; }
        form, .admin-container { padding: 20px; }
        fieldset { border: 1px solid var(--border-color); border-radius: 8px; padding: 20px 15px; margin-bottom: 25px; background-color: rgba(255, 255, 255, 0.5); }
        legend { font-weight: bold; font-size: 1.2em; color: var(--primary-color); padding: 5px 15px; border-radius: 20px; background-color: #fff; border: 1px solid var(--border-color); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; }
        input[type="text"], input[type="tel"], input[type="password"], select, textarea, input[type="file"], input[type="date"], input[type="email"] { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; box-sizing: border-box; font-size: 16px; background-color: rgba(255, 255, 255, 0.9); }
        .radio-group label { display: flex; align-items: center; margin-bottom: 10px; font-weight: normal; cursor: pointer; transition: all 0.2s ease-in-out; }
        .radio-group input { margin-right: 10px; flex-shrink: 0; }
        
        .radio-group label.selected-label { font-weight: 700; color: var(--primary-color); }

        button { width: 100%; padding: 15px; background-color: var(--primary-color); color: white; border: none; border-radius: 6px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: background-color 0.3s, transform 0.2s; }
        button:hover:not(:disabled) { background-color: #00487a; transform: translateY(-2px); }
        button:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        .hidden { display: none; }

        .keterangan-box { margin-top: 15px; padding: 15px; background-color: rgba(240, 248, 255, 0.85); border-radius: 8px; border-left: 5px solid var(--primary-color); transition: all 0.3s ease-in-out; }
        .keterangan-text { margin: 0; font-size: 0.9em; color: #333; line-height: 1.5; }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: center; padding: 15px; box-sizing: border-box; backdrop-filter: blur(5px); }
        .spinner { border: 8px solid #f3f3f3; border-top: 8px solid var(--primary-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #loading-overlay p { color: white; margin-top: 20px; font-size: 1.2em; }
        
        #summary-content p { margin: 8px 0; }
        #summary-content .summary-label { font-weight: 600; color: #555; }
        #summary-content .summary-value { color: #000; }

        .admin-section { padding: 20px; border-bottom: 1px solid #eee; }
        .admin-section h2 { margin-top: 0; color: var(--primary-color); }
        .toggle-switch { display: flex; align-items: center; gap: 10px; }
        #form-status-toggle { width: 50px; height: 26px; position: relative; cursor: pointer; }
        #form-status-toggle span { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 26px; }
        #form-status-toggle span:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        #form-status-toggle.on span { background-color: var(--success-color); }
        #form-status-toggle.on span:before { transform: translateX(24px); }
        
        #submissions-table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; font-family: 'Arial Narrow', Arial, sans-serif; }
        #submissions-table th, #submissions-table td { border: 1px solid #ddd; padding: 6px 8px; text-align: left; font-size: 0.85em; word-break: break-word; }
        #submissions-table th { background-color: #f2f2f2; white-space: normal; vertical-align: middle; }
        #submissions-table td { white-space: normal; }

        .table-container { max-height: 500px; overflow-x: auto; }
        #logout-button { background-color: var(--error-color); margin-top: 20px; }
        .admin-controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; align-items: center; }
        #search-input, #status-filter { padding: 8px; font-size: 0.9em; border-radius: 5px; border: 1px solid #ccc; }
        #search-input { flex-grow: 1; }
        .download-button { width: auto; padding: 8px 12px; font-size: 0.9em; background-color: var(--success-color); }
        .pagination-controls { display: flex; justify-content: center; align-items: center; gap: 5px; margin-top: 15px; }
        .pagination-controls button { width: auto; padding: 5px 10px; font-size: 0.9em; }
        .pagination-controls .page-info { font-size: 0.9em; }
        #submissions-table td select { padding: 6px; border-radius: 5px; width:100%; font-weight: bold; border-width: 1px; transition: background-color 0.3s, border-color 0.3s; font-size: 1em; }
        .status-pending { background-color: var(--pending-bg); color: var(--pending-color); border-color: var(--pending-border); }
        .status-selesai { background-color: var(--completed-bg); color: var(--completed-color); border-color: var(--completed-border); }
        .status-ditolak { background-color: var(--rejected-bg); color: var(--rejected-color); border-color: var(--rejected-border); }
        
        .input-hint { font-size: 0.8em; color: #555; margin-top: 5px; }

        body.admin-view { padding: 0; background-image: none; background-color: #f0f2f5; }

        @media (min-width: 769px) { #admin-dashboard .container { max-width: none; width: 100%; min-height: 100vh; margin: 0; border-radius: 0; box-shadow: none; } }
        @media (max-width: 768px) {
            body { padding: 5px; }
            .container { margin: 10px auto; padding: 0; }
            #admin-dashboard .container, #admin-login-page .container { width: 100%; margin: 5px 0; padding: 0; border: none; border-radius: 0; background-color: transparent; backdrop-filter: none; box-shadow: none; }
            #admin-dashboard .admin-container, #admin-login-page .admin-container { padding: 10px; background-color: #f9f9f9; border-radius: 8px; }
            #admin-dashboard header { border-radius: 8px 8px 0 0; }
            .table-container { overflow-x: hidden; max-height: none; }
            #submissions-table, #submissions-table thead, #submissions-table tbody, #submissions-table th, #submissions-table td, #submissions-table tr { display: block; }
            #submissions-table thead { display: none; }
            #submissions-table tr { margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
            #submissions-table td { display: flex; justify-content: space-between; align-items: center; padding: 12px; text-align: right; border: none; border-bottom: 1px solid #eee; }
            #submissions-table td:last-child { border-bottom: none; }
            #submissions-table td::before { content: attr(data-label); font-weight: bold; text-align: left; margin-right: 15px; color: var(--primary-color); flex-shrink: 0; }
            .admin-controls { flex-direction: column; align-items: stretch; }
            #submissions-table td.empty-cell { display: none; }
        }
    </style>
</head>
<body>
    <div id="loading-overlay" class="overlay"><div class="spinner"></div><p>Mohon tunggu...</p></div>

    <!-- Modal Konfirmasi Data Pengguna -->
    <div id="confirmation-modal" class="overlay">
        <div style="background: white; padding: 20px 30px; border-radius: 12px; max-width: 500px; width: 100%; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
            <h2 style="margin-top:0; color: var(--primary-color); text-align: center; border-bottom: 2px solid #eee; padding-bottom: 15px;">Konfirmasi Data Anda</h2>
            <div id="summary-content" style="text-align: left; line-height: 1.8; max-height: 60vh; overflow-y: auto; padding-right: 10px;">
                <!-- Ringkasan data akan dimasukkan di sini oleh JavaScript -->
            </div>
            <p style="font-size: 0.9em; color: #555; text-align: center; margin-top: 20px;">Pastikan semua data yang Anda isikan sudah benar sebelum mengirim.</p>
            <div style="display: flex; justify-content: space-between; margin-top: 25px; gap: 15px;">
                <button id="edit-data-btn" style="background-color: #6c757d; width: 100%; padding: 12px;">Perbaiki Data</button>
                <button id="confirm-submit-btn" style="background-color: var(--success-color); width: 100%; padding: 12px;">Ya, Kirim Data</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Alasan Penolakan -->
    <div id="rejection-modal" class="overlay">
        <div style="background: white; padding: 20px 30px; border-radius: 12px; max-width: 500px; width: 100%; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
            <h2 style="margin-top:0; color: var(--error-color);">Alasan Penolakan</h2>
            <p style="font-size: 0.9em; color: #555; margin-top: 0;">Mohon berikan alasan mengapa pengajuan ini ditolak. Alasan ini akan dikirimkan ke pengguna.</p>
            <div class="form-group">
                <textarea id="rejection-reason" rows="4" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box;" placeholder="Contoh: Foto KTP tidak jelas, Nopol tidak sesuai, dll."></textarea>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 20px; gap: 15px;">
                <button id="cancel-rejection-btn" style="background-color: #6c757d; width: 100%; padding: 12px;">Batal</button>
                <button id="confirm-rejection-btn" style="background-color: var(--error-color); width: 100%; padding: 12px;">Kirim Penolakan</button>
            </div>
        </div>
    </div>

    <div id="main-form-container">
         <div class="container">
            <header>
                <img src="https://raw.githubusercontent.com/srpcom/koesmaparkir/main/new%20logo%20rsud%202025%20kecil.png" alt="Logo" class="logo-image">
                <h1>Daftar Hadir BIMTEK SPT TAHUNAN PPh MELALUI APLIKASI CORE TAX</h1>
                <!-- <p>RSUD dr. R. KOESMA TUBAN</p> --> <!-- Dihapus sesuai permintaan -->
            </header>
            <div id="form-closed-message" class="admin-container hidden" style="text-align: center; padding: 40px;">
                <h2>Formulir Ditutup</h2>
                <p>Mohon maaf, saat ini formulir sedang ditutup sementara oleh administrator.</p>
            </div>
            <form id="parkingForm" novalidate>
                 <fieldset>
                    <legend>Data Peserta</legend>
                    
                    <div class="form-group">
                        <label for="nama">NAMA</label>
                        <input type="text" id="nama" name="nama" required>
                        <p id="nama-hint" class="input-hint hidden">masukkan nama SESUAI KTP</p>
                    </div>

                    <div class="form-group">
                        <label for="email">EMAIL</label>
                        <input type="email" id="email" name="email" required>
                        <p id="email-hint" class="input-hint hidden">masukkan email</p>
                    </div>

                    <div class="form-group">
                        <label for="nik">NIK</label>
                        <input type="text" id="nik" name="nik" pattern="[0-9]*" inputmode="numeric" required>
                        <p id="nik-hint" class="input-hint hidden">masukkan NIK / Nomor KTP</p>
                    </div>

                    <div class="form-group">
                        <label for="nomorHp">NOMOR HP</label>
                        <input type="tel" id="nomorHp" name="nomorHp" required>
                        <p id="nomorHp-hint" class="input-hint hidden">contoh format: 081330639240</p>
                    </div>

                    <div class="form-group">
                        <label for="ruangan">RUANGAN</label>
                        <select id="ruangan" name="ruangan" onchange="handleRuanganChange(this)" required>
                            <option value="">-- Pilih Unit / Bagian --</option>
                            <option value="INSTALASI FARMASI">INSTALASI FARMASI</option>
                            <option value="INSTALASI RADIOLOGI">INSTALASI RADIOLOGI</option>
                            <option value="INSTALASI BEDAH SENTRAL">INSTALASI BEDAH SENTRAL</option>
                            <option value="INSTALASI GAWAT DARURAT">INSTALASI GAWAT DARURAT</option>
                            <option value="ICU">ICU</option>
                            <option value="ICCU">ICCU</option>
                            <option value="HCU">HCU</option>
                            <option value="INSTALASI LABORATORIUM">INSTALASI LABORATORIUM</option>
                            <option value="INSTALASI HEMODIALISA">INSTALASI HEMODIALISA</option>
                            <option value="INSTALASI GIZI">INSTALASI GIZI</option>
                            <option value="INSTALASI REKAM MEDIK">INSTALASI REKAM MEDIK</option>
                            <option value="INSTALASI PEMELIHARAAN SARANA">INSTALASI PEMELIHARAAN SARANA</option>
                            <option value="INSTALASI PENYEHATAN LINGKUNGAN">INSTALASI PENYEHATAN LINGKUNGAN</option>
                            <option value="INSTALASI FORENSIK DAN MEDIKOLEGAL">INSTALASI FORENSIK DAN MEDIKOLEGAL</option>
                            <option value="INSTALASI DIAGNOSTIK DAN INTERVENSI KORDIOVASKULER">INSTALASI DIAGNOSTIK DAN INTERVENSI KORDIOVASKULER</option>
                            <option value="INSTALASI MATERNAL DAN PERINATAL">INSTALASI MATERNAL DAN PERINATAL</option>
                            <option value="INSTALASI REHABILITASI MEDIK">INSTALASI REHABILITASI MEDIK</option>
                            <option value="INSTALASI SIM RS">INSTALASI SIM RS</option>
                            <option value="INSTALASI PKRS">INSTALASI PKRS</option>
                            <option value="POLI KIR">POLI KIR</option>
                            <option value="POLI EKSKUTIF">POLI EKSKUTIF</option>
                            <option value="POLI TMS">POLI TMS</option>
                            <option value="POLI EEG">POLI EEG</option>
                            <option value="POLI ENDOSKOPI">POLI ENDOSKOPI</option>
                            <option value="POLI ESWL">POLI ESWL</option>
                            <option value="RUANG MAWAR/ASTER">RUANG MAWAR/ASTER</option>
                            <option value="RUANG ANYELIR/MELATI">RUANG ANYELIR/MELATI</option>
                            <option value="RUANG ANGGREK/DAHLIA">RUANG ANGGREK/DAHLIA</option>
                            <option value="RUANG BOUGENVILLE">RUANG BOUGENVILLE</option>
                            <option value="RUANG TERATAI/ASOKA">RUANG TERATAI/ASOKA</option>
                            <option value="RUANG LILY">RUANG LILY</option>
                            <option value="RUANG FLAMBOYAN">RUANG FLAMBOYAN</option>
                            <option value="POLI ANAK">POLI ANAK</option>
                            <option value="POLI PENYAKIT DALAM">POLI PENYAKIT DALAM</option>
                            <option value="POLI BEDAH">POLI BEDAH</option>
                            <option value="POLI MATA">POLI MATA</option>
                            <option value="POLI THT">POLI THT</option>
                            <option value="POLI SYARAF">POLI SYARAF</option>
                            <option value="POLI JANTUNG">POLI JANTUNG</option>
                            <option value="POLI PARU">POLI PARU</option>
                            <option value="POLI GIGI">POLI GIGI</option>
                            <option value="POLI KULIT DAN KELAMIN">POLI KULIT DAN KELAMIN</option>
                            <option value="POLI JIWA">POLI JIWA</option>
                            <option value="POLI TB">POLI TB</option>
                            <option value="POLI VCT">POLI VCT</option>
                            <option value="POLI UMUM">POLI UMUM</option>
                            <option value="POLI GERIATRI">POLI GERIATRI</option>
                            <option value="POLI UROLOGI">POLI UROLOGI</option>
                            <option value="POLI ORTHOPEDI">POLI ORTHOPEDI</option>
                            <option value="POLI OBSGYN">POLI OBSGYN</option>
                            <option value="POLI BEDAH SYARAF">POLI BEDAH SYARAF</option>
                            <option value="BAGIAN PROGPEL">BAGIAN PROGPEL</option>
                            <option value="BAGIAN KEUANGAN">BAGIAN KEUANGAN</option>
                            <option value="BAGIAN ADMINISTRASI DAN UMUM">BAGIAN ADMINISTRASI DAN UMUM</option>
                            <option value="BIDANG PELAYANAN MEDIK">BIDANG PELAYANAN MEDIK</option>
                            <option value="BIDANG KEPERAWATAN">BIDANG KEPERAWATAN</option>
                            <option value="BIDANG PELAYANAN PENUNJANG">BIDANG PENUNJANG</option>
                            <option value="KOMITE MEDIK">KOMITE MEDIK</option>
                            <option value="KOMITE KEPERAWATAN">KOMITE KEPERAWATAN</option>
                            <option value="KOMITE PPI">KOMITE PPI</option>
                            <option value="KOMITE KESEHATAN DAN KESELAMATAN KERJA">KOMITE KESEHATAN DAN KESELAMATAN KERJA</option>
                            <option value="SATUAN PEMERIKSAAN INTERNAL">SATUAN PEMERIKSAAN INTERNAL</option>
                            <option value="UNIT AMBULAN">UNIT AMBULAN</option>
                            <option value="UNIT LOUNDRY">UNIT LOUNDRY</option>
                            <option value="UNIT CSSD">UNIT CSSD</option>
                            <option value="UNIT PENGADUAN">UNIT PENGADUAN</option>
                            <option value="UNIT DIKLAT">UNIT DIKLAT</option>
                            <option value="UNIT KLAIM DAN PENJAMINAN">UNIT KLAIM DAN PENJAMINAN</option>
                            <option value="LAINNYA">Lainnya...</option>
                        </select>
                    </div>
                    <div class="form-group hidden" id="ruanganLainnya-group">
                        <label for="ruanganLainnya">Tulis Nama Unit Anda</label>
                        <input type="text" id="ruanganLainnya" name="ruanganLainnya">
                    </div>

                    <!-- Kolom upload fileKtp dihapus, jika masih diperlukan, tambahkan kembali di sini -->
                    <!-- 
                    <div class="form-group">
                        <label for="fileKtp">Upload Identitas (KTP/SIM)</label>
                        <input type="file" id="fileKtp" name="fileKtp" accept=".jpg,.jpeg,.png,.pdf">
                    </div> 
                    -->
                </fieldset>
                
                <button type="submit" id="submit-button">Kirim Daftar Hadir</button>
            </form>
        </div>
    </div>
    
    <!-- HALAMAN ADMIN DIMULAI DI SINI -->
    <div id="admin-login-page" class="hidden">
        <div class="container">
            <header><h1>Login Admin</h1></header>
            <div class="admin-container">
                <div class="form-group"><label for="admin-password">Password</label><input type="password" id="admin-password" required></div>
                <button id="admin-login-button">Login</button>
                <p id="login-error" class="hidden" style="color:red; text-align:center; margin-top:10px;"></p>
            </div>
        </div>
    </div>
    <div id="admin-dashboard" class="hidden">
        <div class="container">
            <header><h1>Dashboard Admin</h1></header>
            <div class="admin-container">
                <div class="admin-section">
                    <h2>Pengaturan Formulir</h2>
                    <div class="toggle-switch">
                        <label>Formulir:</label>
                        <div id="form-status-toggle" onclick="toggleFormStatus()"><span></span></div>
                        <strong id="form-status-text"></strong>
                    </div>
                </div>
                <div class="admin-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <h2>Data Submisi</h2>
                        <button id="refresh-data" style="width:auto; padding: 5px 10px; font-size: 0.8em;" onclick="fetchPage(1)">Refresh</button>
                    </div>
                    <div class="admin-controls">
                        <input type="text" id="search-input" placeholder="Cari data...">
                        <select id="status-filter">
                            <option value="Semua">Semua Status</option>
                            <option value="Belum diproses">Belum diproses</option>
                            <option value="Selesai">Selesai</option>
                            <option value="Ditolak">Ditolak</option>
                        </select>
                        <button id="download-xlsx" class="download-button">Unduh .xlsx</button>
                    </div>
                    <div class="table-container">
                        <table id="submissions-table">
                            <thead></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div id="pagination-controls" class="pagination-controls"></div>
                </div>
                <button id="logout-button">Logout</button>
            </div>
        </div>
    </div>
    <!-- HALAMAN ADMIN BERAKHIR DI SINI -->

    <footer style="text-align: center; color: #fff; font-size: 0.8em; padding: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">ver 1.6 | Developed with ❤️ by : syam</footer>

    <script>
        // Variabel global
        const webAppUrl = 'https://script.google.com/macros/s/AKfycbxDeMKoEFVbdquVQ3MM9Dhme54vJEQI6He8BJ7Dhtax6h3dzz6hXtJdOwpge8NfbRwoDw/exec';
        let formDataToSubmit = null; 
        let submissionHeaders = [];
        let currentPage = 1;
        let rejectionContext = {
            rowIndex: null,
            selectElement: null,
            previousValue: ''
        };
        
        // Elemen DOM
        const mainFormContainer = document.getElementById('main-form-container');
        const adminLoginPage = document.getElementById('admin-login-page');
        const adminDashboard = document.getElementById('admin-dashboard');
        const searchInput = document.getElementById('search-input');
        const statusFilter = document.getElementById('status-filter');
        const downloadButton = document.getElementById('download-xlsx');

        // --- ROUTING APLIKASI ---
        window.addEventListener('hashchange', handleRouteChange);
        window.addEventListener('load', handleRouteChange);

        function handleRouteChange() {
            if (window.location.hash === '#admin') {
                sessionStorage.getItem('isAdminAuthenticated') === 'true' ? showDashboard() : showAdminLogin();
            } else {
                showMainForm();
            }
        }
        function showMainForm() { mainFormContainer.classList.remove('hidden'); adminLoginPage.classList.add('hidden'); adminDashboard.classList.add('hidden'); document.body.classList.remove('admin-view'); checkFormStatusForUser(); }
        function showAdminLogin() { mainFormContainer.classList.add('hidden'); adminLoginPage.classList.remove('hidden'); adminDashboard.classList.add('hidden'); document.body.classList.remove('admin-view'); }
        function showDashboard() { mainFormContainer.classList.add('hidden'); adminLoginPage.classList.add('hidden'); adminDashboard.classList.remove('hidden'); document.body.classList.add('admin-view'); loadAdminData(); }
        
        // --- LOGIKA FORMULIR PENGGUNA ---
        document.getElementById('parkingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (!this.checkValidity()) {
                alert('Mohon lengkapi semua kolom yang wajib diisi.');
                return;
            }
            formDataToSubmit = new FormData(this);
            displayConfirmationSummary(formDataToSubmit);
        });
        function displayConfirmationSummary(formData) {
            const summaryContainer = document.getElementById('summary-content');
            let summaryHTML = '';
            
            // PERUBAHAN: Menyesuaikan label untuk data baru
            const fieldLabels = {
                nama: 'NAMA',
                email: 'EMAIL',
                nik: 'NIK',
                nomorHp: 'NOMOR HP',
                ruangan: 'RUANGAN',
                ruanganLainnya: 'RUANGAN (Lainnya)',
                fileKtp: 'File Identitas' // Opsional jika fileKtp masih digunakan
            };

            for (let [key, value] of formData.entries()) {
                if (value && value.toString().trim() !== '') {
                    let displayValue = value instanceof File ? value.name : value;
                    if (key === 'ruangan' && value === 'LAINNYA') continue; // Jangan tampilkan 'LAINNYA'
                    
                    // Ganti nama 'ruanganLainnya' menjadi 'ruangan' di ringkasan jika 'ruangan' adalah 'LAINNYA'
                    if (key === 'ruanganLainnya') {
                         key = 'ruangan';
                         displayValue = value + " (Lainnya)";
                    }
                    
                    summaryHTML += `<p><span class="summary-label">${fieldLabels[key] || key}:</span> <span class="summary-value">${displayValue}</span></p>`;
                }
            }
            summaryContainer.innerHTML = summaryHTML;
            document.getElementById('confirmation-modal').style.display = 'flex';
        }
        document.getElementById('edit-data-btn').addEventListener('click', () => {
            document.getElementById('confirmation-modal').style.display = 'none';
            formDataToSubmit = null;
        });
        document.getElementById('confirm-submit-btn').addEventListener('click', () => {
            document.getElementById('confirmation-modal').style.display = 'none';
            if (formDataToSubmit) submitFinalData(formDataToSubmit);
        });
        async function submitFinalData(formData) {
            showLoading(true, "Mengirim data...");
            const formDataObject = Object.fromEntries(formData.entries());
            try {
                // Logika kompresi file masih ada, jika Anda memutuskan untuk menggunakan upload fileKtp lagi
                const fileInput = formData.get('fileKtp');
                if (fileInput && fileInput.size > 0) {
                    formDataObject.fileKtp = await compressAndReadFile(fileInput);
                }
                
                const response = await fetch(webAppUrl, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(formDataObject) });
                const result = await response.json();
                if (result.status === 'success') {
                    alert('Kehadiran Anda telah berhasil dicatat!');
                    document.getElementById('parkingForm').reset();
                    // Logika lama yang dihapus:
                    // toggleSections();
                    // handleStatusKepegawaianChange();
                    // handleAlasanChange();
                } else { throw new Error(result.message || 'Terjadi kesalahan di server.'); }
            } catch(error) {
                console.error('Submit Error:', error);
                alert('Terjadi kesalahan koneksi. Pesan: ' + error.message);
            } finally {
                showLoading(false);
                formDataToSubmit = null;
            }
        }
        
        // --- LOGIKA HALAMAN ADMIN ---
        // (Tidak ada perubahan signifikan di sini, semua logika admin tetap sama)
        // ... (Semua fungsi admin seperti adminLogin, adminLogout, loadAdminData, dll. tetap ada) ...
        document.getElementById('admin-login-button').addEventListener('click', adminLogin);
        document.getElementById('logout-button').addEventListener('click', adminLogout);
        searchInput.addEventListener('keyup', () => fetchPage(1));
        statusFilter.addEventListener('change', () => fetchPage(1));
        downloadButton.addEventListener('click', downloadXLSX);

        async function adminLogin() {
            const password = document.getElementById('admin-password').value;
            const loginError = document.getElementById('login-error');
            showLoading(true, "Memverifikasi...");
            try {
                const response = await fetch(`${webAppUrl}?action=adminLogin&password=${encodeURIComponent(password)}`);
                const result = await response.json();
                if (result.status === 'success') {
                    sessionStorage.setItem('isAdminAuthenticated', 'true');
                    loginError.classList.add('hidden');
                    document.getElementById('admin-password').value = '';
                    showDashboard();
                } else {
                    loginError.textContent = result.message || "Password salah.";
                    loginError.classList.remove('hidden');
                }
            } catch (error) { loginError.textContent = "Gagal terhubung ke server."; loginError.classList.remove('hidden'); } 
            finally { showLoading(false); }
        }
        function adminLogout() { sessionStorage.removeItem('isAdminAuthenticated'); document.body.classList.remove('admin-view'); window.location.hash = ''; }
        async function loadAdminData() { await loadSettings(); await fetchPage(1); }
        async function loadSettings() {
            try {
                const response = await fetch(`${webAppUrl}?action=getSettings`);
                const result = await response.json();
                if (result.status === 'success') {
                    const status = result.data.formStatus;
                    const toggle = document.getElementById('form-status-toggle');
                    toggle.classList.toggle('on', status === 'ON');
                    document.getElementById('form-status-text').textContent = status;
                }
            } catch (e) { console.error("Gagal memuat pengaturan:", e); }
        }
        async function toggleFormStatus() {
            const newStatus = document.getElementById('form-status-toggle').classList.contains('on') ? 'OFF' : 'ON';
            showLoading(true, 'Memperbarui...');
            try {
                await fetch(`${webAppUrl}?action=updateSettings&formStatus=${newStatus}`);
                await loadSettings();
            } catch (e) { console.error("Gagal mengubah status:", e); }
            finally { showLoading(false); }
        }
        async function fetchPage(page) {
            currentPage = page;
            const searchTerm = searchInput.value;
            const status = statusFilter.value;
            showLoading(true, "Memuat data...");
            const tableBody = document.querySelector('#submissions-table tbody');
            tableBody.innerHTML = `<tr><td colspan="15" style="text-align:center;">Memuat data...</td></tr>`;
            try {
                const url = new URL(webAppUrl);
                url.searchParams.append('action', 'getSubmissions');
                url.searchParams.append('page', page);
                url.searchParams.append('searchTerm', searchTerm);
                url.searchParams.append('statusFilter', status);
                const response = await fetch(url);
                const result = await response.json();
                if (result.status === 'success') {
                    const { headers, pageData, currentPage, totalPages } = result.data;
                    submissionHeaders = headers; // Ini didapat dari server, tidak bisa diubah di sini
                    displayData(pageData);
                    setupPagination(currentPage, totalPages);
                } else { tableBody.innerHTML = `<tr><td colspan="15" style="text-align:center; color:red;">Gagal: ${result.message}</td></tr>`; }
            } catch (e) { tableBody.innerHTML = `<tr><td colspan="15" style="text-align:center; color:red;">Gagal terhubung.</td></tr>`; } 
            finally { showLoading(false); }
        }
        function displayData(pageData) {
            const tableBody = document.querySelector('#submissions-table tbody');
            const tableHead = document.querySelector('#submissions-table thead');
            tableBody.innerHTML = '';
            // Header tabel DIBUAT DINAMIS berdasarkan respons server
            tableHead.innerHTML = `<tr>${submissionHeaders.map(h => `<th>${h}</th>`).join('')}</tr>`;
            if (!pageData || pageData.length === 0) {
                tableBody.innerHTML = `<tr><td data-label="Info" colspan="${submissionHeaders.length || 1}" style="text-align:center;">Data tidak ditemukan.</td></tr>`;
                return;
            }
            pageData.forEach(item => {
                const { rowData, originalIndex } = item;
                const tr = document.createElement('tr');
                rowData.forEach((cell, cellIndex) => {
                    const td = document.createElement('td');
                    const header = submissionHeaders[cellIndex]; // Menggunakan header dari server
                    td.setAttribute('data-label', header);
                    if (header === 'Status') {
                        const select = document.createElement('select');
                        select.innerHTML = `<option value="Belum diproses">Belum diproses</option><option value="Selesai">Selesai</option><option value="Ditolak">Ditolak</option><option value="Hapus">Hapus</option>`;
                        select.value = cell;
                        select.setAttribute('data-previous-value', cell);
                        select.onchange = (event) => handleStatusChange(event.target, originalIndex);
                        td.appendChild(select);
                        updateSelectColor(select);
                    } else if (header === 'Link File Identitas' && cell && cell.startsWith('http')) {
                        td.innerHTML = `<a href="${cell}" target="_blank" rel="noopener noreferrer">Lihat File</a>`;
                    } else { td.textContent = cell; }
                    if (header !== 'Status' && (!cell || cell.toString().trim() === '')) td.classList.add('empty-cell');
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        }
        function setupPagination(currentPage, totalPages) {
            const paginationControls = document.getElementById('pagination-controls');
            if (totalPages <= 1) { paginationControls.innerHTML = ''; return; }
            paginationControls.innerHTML = `<button onclick="fetchPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>«</button><span class="page-info">Hal ${currentPage} dari ${totalPages}</span><button onclick="fetchPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>»</button>`;
        }
        function handleStatusChange(selectElement, rowIndex) {
            const newStatus = selectElement.value;
            const previousStatus = selectElement.getAttribute('data-previous-value');
            updateSelectColor(selectElement);

            if (newStatus === 'Ditolak') {
                rejectionContext = {
                    rowIndex: rowIndex,
                    selectElement: selectElement,
                    previousValue: previousStatus
                };
                document.getElementById('rejection-reason').value = '';
                document.getElementById('rejection-modal').style.display = 'flex';
            } else if (newStatus === 'Hapus') {
                if (confirm('Apakah Anda yakin ingin menghapus data ini secara permanen?')) {
                    updateStatus(newStatus, rowIndex);
                } else {
                   selectElement.value = previousStatus;
                   updateSelectColor(selectElement);
                }
            } else {
                updateStatus(newStatus, rowIndex);
            }
        }
        function updateSelectColor(selectElement) {
            selectElement.className = '';
            const value = selectElement.value;
            if (value === 'Belum diproses') selectElement.classList.add('status-pending');
            else if (value === 'Selesai') selectElement.classList.add('status-selesai');
            else if (value === 'Ditolak') selectElement.classList.add('status-ditolak');
        }
        async function updateStatus(newStatus, rowIndex, reason = '') {
            showLoading(true, 'Menyimpan...');
            try {
                const url = new URL(webAppUrl);
                url.searchParams.append('action', 'updateStatus');
                url.searchParams.append('rowIndex', rowIndex);
                url.searchParams.append('status', newStatus);
                if (reason) {
                    url.searchParams.append('reason', reason);
                }
                await fetch(url);
                if (newStatus === 'Hapus') {
                    await fetchPage(currentPage);
                } else {
                    const selectElement = document.querySelector(`select[onchange="handleStatusChange(this, ${rowIndex})"]`);
                    if (selectElement) {
                       selectElement.setAttribute('data-previous-value', newStatus);
                    }
                }
            } catch (e) { 
                alert("Gagal menyimpan status."); 
                if (rejectionContext.selectElement) {
                    rejectionContext.selectElement.value = rejectionContext.previousValue;
                    updateSelectColor(rejectionContext.selectElement);
                }
            } 
            finally { showLoading(false); }
        }
        async function downloadXLSX() {
            showLoading(true, "Mempersiapkan unduhan...");
            try {
                const url = new URL(webAppUrl);
                url.searchParams.append('action', 'downloadData');
                url.searchParams.append('searchTerm', searchInput.value);
                url.searchParams.append('statusFilter', statusFilter.value);
                const response = await fetch(url);
                const result = await response.json();
                if (result.status === 'success' && result.data.rows.length > 0) {
                    const { headers, rows } = result.data;
                    const worksheet = XLSX.utils.aoa_to_sheet([headers, ...rows]);
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, "Submisi");
                    XLSX.writeFile(workbook, "Data_Daftar_Hadir.xlsx"); // Nama file diubah
                } else { alert("Tidak ada data untuk diunduh."); }
            } catch(e) { alert("Gagal mengunduh data."); } 
            finally { showLoading(false); }
        }

        // --- FUNGSI HELPERS & INISIALISASI ---
        async function checkFormStatusForUser() { try { const response = await fetch(`${webAppUrl}?action=getSettings`); const result = await response.json(); const isOff = result.status === 'success' && result.data.formStatus === 'OFF'; document.getElementById('parkingForm').classList.toggle('hidden', isOff); document.getElementById('form-closed-message').classList.toggle('hidden', !isOff); } catch(e) { console.error("Gagal memeriksa status form.", e); } }
        
        // FUNGSI LAMA (DIHAPUS):
        // const formSections = { ... };
        // function toggleSections(){ ... }
        // function handleStatusKepegawaianChange() { ... }
        // function handleAlasanChange() { ... }

        function handleRadioStyle(radioElement) { if (!radioElement) return; const radioName = radioElement.name; const allLabels = document.querySelectorAll(`input[name="${radioName}"]`); allLabels.forEach(radio => { radio.parentElement.classList.remove('selected-label'); }); radioElement.parentElement.classList.add('selected-label'); }
        
        // PERUBAHAN: Mengganti nama fungsi agar sesuai dengan ID baru
        function handleRuanganChange(select){ 
            const lainnyaGroup = document.getElementById('ruanganLainnya-group'); 
            const lainnyaInput = document.getElementById('ruanganLainnya'); 
            const isLainnya = select.value === 'LAINNYA'; 
            lainnyaGroup.classList.toggle('hidden', !isLainnya); 
            lainnyaInput.required = isLainnya; 
            if (!isLainnya) lainnyaInput.value = ''; 
        }

        function compressAndReadFile(file){ return new Promise((resolve, reject) => { if (!file.type.startsWith('image/')) { const reader = new FileReader(); reader.onload = () => resolve({ base64: reader.result.split(',')[1], type: file.type, name: file.name }); reader.onerror = reject; reader.readAsDataURL(file); return; } const reader = new FileReader(); reader.onload = e => { const img = new Image(); img.onload = () => { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const MAX_WIDTH = 1024; const scaleSize = MAX_WIDTH / img.width; canvas.width = MAX_WIDTH; canvas.height = img.height * scaleSize; ctx.drawImage(img, 0, 0, canvas.width, canvas.height); const dataUrl = canvas.toDataURL('image/jpeg', 0.8); resolve({ base64: dataUrl.split(',')[1], type: 'image/jpeg', name: 'compressed_id.jpg' }); }; img.src = e.target.result; }; reader.onerror = reject; reader.readAsDataURL(file); }); }
        function showLoading(show, message = "Mohon tunggu...") { const overlay = document.getElementById('loading-overlay'); overlay.style.display = show ? 'flex' : 'none'; overlay.querySelector('p').textContent = message; }
        
        window.addEventListener('load', () => { 
            handleRouteChange(); 
            // toggleSections(); // Dihapus

            document.getElementById('cancel-rejection-btn').addEventListener('click', () => {
                if (rejectionContext.selectElement) {
                    rejectionContext.selectElement.value = rejectionContext.previousValue;
                    updateSelectColor(rejectionContext.selectElement);
                }
                document.getElementById('rejection-modal').style.display = 'none';
            });

            document.getElementById('confirm-rejection-btn').addEventListener('click', () => {
                const reason = document.getElementById('rejection-reason').value.trim();
                if (!reason) {
                    alert('Alasan penolakan tidak boleh kosong.');
                    return;
                }
                if (rejectionContext.rowIndex !== null) {
                    updateStatus('Ditolak', rejectionContext.rowIndex, reason);
                }
                document.getElementById('rejection-modal').style.display = 'none';
            });

            // --- FUNGSI BARU: Menambahkan event listener untuk hints ---
            function setupHint(inputId, hintId) {
                const input = document.getElementById(inputId);
                const hint = document.getElementById(hintId);
                if (input && hint) {
                    input.addEventListener('focus', () => { hint.classList.remove('hidden'); });
                    input.addEventListener('blur', () => { hint.classList.add('hidden'); });
                }
            }
            
            setupHint('nama', 'nama-hint');
            setupHint('email', 'email-hint');
            setupHint('nik', 'nik-hint');
            setupHint('nomorHp', 'nomorHp-hint');

            // Mengganti 'telepon' menjadi 'nomorHp' jika ada
            // const teleponInput = document.getElementById('telepon'); // Diganti
            // const teleponHint = document.getElementById('telepon-hint'); // Diganti
            // if (teleponInput && teleponHint) {
            //     teleponInput.addEventListener('focus', () => { teleponHint.classList.remove('hidden'); });
            //     teleponInput.addEventListener('blur', () => { teleponHint.classList.add('hidden'); });
            // }
        });
    </script>
</body>
</html>

